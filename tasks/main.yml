---
## JailKit repository
- name: Include jailkit
  include: jailkit.yml
  tags:
    - ispconfig

## Debconf configurations and package installations
- name: Include apt
  include: apt.yml
  tags:
    - ispconfig

## Postfix templating
- name: Include postfix
  include: postfix.yml
  tags:
    - ispconfig

## Mailman templating
- name: "Mailman | Check /etc/facts.conf for mailman=yes"
  shell: grep -c mailman=yes /etc/facts/conf
  register: facts_mailman
  failed_when: "'FAILED' in facts_mailman.stderr"

- name: Include mailman
  include: mailman.yml
  tags:
    - ispconfig
  when: mailman_email is defined and facts_mailman == "0"

## PureFTPd Configuration
- name: Include pure-ftpd
  include: pure-ftpd.yml
  tags:
    - ispconfig

## Apache2 Configuration
- name: Include apache2
  include: apache2.yml
  tags:
    - ispconfig
  when: not ansible_check_mode

## MySQL Configuration
- name: Include mysql
  include: mysql.yml
  tags:
    - ispconfig
  when: not ansible_check_mode

- name: "MySQL Secure | Check /etc/facts.conf for mysql_secure=yes"
  shell: grep -c mysql_secure=yes /etc/facts/conf
  register: facts_mysql_secure
  failed_when: "'FAILED' in facts_mysql_secure.stderr"

- name: Include mysql-secure
  include: mysql_secure_installation.yml
  tags:
    - ispconfig
  when: not ansible_check_mode and facts_mysql_secure == "0"

## Roundcube Configuration
- name: Include roundcube
  include: roundcube.yml
  tags:
    - ispconfig

## Various Configurations
- name: Include others
  include: others.yml
  tags:
    - ispconfig

## ISPConfig Installer Download
- name: "ISPConfig Installer | Check if folder already exist"
  stat:
    path: /tmp/ispconfig3_install
  register: isp_install_dir

- name: Include ispconfig-installer
  include: ispconfig-installer.yml
  tags:
    - ispconfig
  when: isp_install_dir.stat.exists

## ISPConfig Configuration with Let's Encrypt SSL (after being generated)
- name: "ISPConfig-SSL | Check if let's encrypt SSL for ISPConfig exist"
  stat:
    path: /etc/letsencrypt/live/{{ ansible_fqdn }}/fullchain.pem
  register: le_ssl

- name: Include ispconfig-ssl
  include: ispconfig-installer.yml
  tags:
    - ispconfig
  when: le_ssl.stat.exists

## Restarting Services
- name: Include services
  include: services.yml
  tags:
    - ispconfig
